name: Recompile, Sign, and Release APK

on:
  workflow_dispatch:

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download Apktool
        run: |
          wget -q https://github.com/iBotPeaches/Apktool/releases/download/v2.9.3/apktool_2.9.3.jar -O apktool.jar

      - name: Install Build Tools
        run: |
          sudo apt-get update && sudo apt-get install -y zipalign

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > release.keystore

      - name: Find App Name
        id: find_app
        run: |
          APP_DIR=$(find decompiled -mindepth 1 -maxdepth 1 -type d | head -n 1)
          if [ -z "$APP_DIR" ]; then
            echo "âŒ No app directory found under 'decompiled/'"
            exit 1
          fi
          APP_NAME=$(basename "$APP_DIR")
          echo "âœ… Found app: $APP_NAME"
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT

      - name: Recompile APK
        id: recompile
        run: |
          APP_NAME="${{ steps.find_app.outputs.app_name }}"
          SOURCE_DIR="decompiled/${APP_NAME}/apktool"
          UNSIGNED_APK="rebuilt_unsigned.apk"

          if [ ! -d "$SOURCE_DIR" ]; then
            echo "âŒ Source directory not found: $SOURCE_DIR"
            exit 1
          fi

          echo "ðŸ”¨ Recompiling APK from $SOURCE_DIR..."
          java -jar apktool.jar b "$SOURCE_DIR" -o "$UNSIGNED_APK"
          echo "âœ… Recompile complete: $UNSIGNED_APK"
          echo "unsigned_apk_path=$UNSIGNED_APK" >> $GITHUB_OUTPUT

      - name: Sign APK with jarsigner
        id: sign
        run: |
          UNSIGNED_APK="${{ steps.recompile.outputs.unsigned_apk_path }}"
          SIGNED_UNALIGNED_APK="rebuilt_signed_unaligned.apk"

          # jarsigner signs in-place, so create a copy to preserve the unsigned APK
          cp "$UNSIGNED_APK" "$SIGNED_UNALIGNED_APK"

          echo "ðŸ”‘ Signing APK with jarsigner..."
          jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 \
            -keystore release.keystore \
            -storepass "${{ secrets.KEYSTORE_PASSWORD }}" \
            -keypass "${{ secrets.KEY_PASSWORD }}" \
            "$SIGNED_UNALIGNED_APK" "${{ secrets.KEY_ALIAS }}"
          echo "âœ… Signing complete: $SIGNED_UNALIGNED_APK"
          echo "signed_apk_path=$SIGNED_UNALIGNED_APK" >> $GITHUB_OUTPUT

      - name: Zipalign APK
        id: zipalign
        run: |
          APP_NAME="${{ steps.find_app.outputs.app_name }}"
          UNALIGNED_APK="${{ steps.sign.outputs.signed_apk_path }}"
          FINAL_APK="${APP_NAME}_release.apk"
          echo "ðŸ“¦ Aligning APK..."
          zipalign -f 4 "$UNALIGNED_APK" "$FINAL_APK"
          echo "âœ… Zipalign complete: $FINAL_APK"
          echo "final_apk_path=$FINAL_APK" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: release-${{ steps.find_app.outputs.app_name }}-${{ github.run_number }}
          name: "Release ${{ steps.find_app.outputs.app_name }} #${{ github.run_number }}"
          body: |
            ðŸš€ **${{ steps.find_app.outputs.app_name }}**

            - Recompiled from `decompiled/${{ steps.find_app.outputs.app_name }}/apktool`
            - Signed with `jarsigner` and optimized with `zipalign`.
            - Workflow run: ${{ github.run_id }}
          files: "${{ steps.zipalign.outputs.final_apk_path }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}